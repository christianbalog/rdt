apiVersion: v1
kind: ConfigMap
metadata:
  name: sqlite-init-scripts
  namespace: default
  labels:
    app: sqlite
data:
  init-surveillance.sql: |
    -- Initialisation de la base de données surveillance.db (Structure Simplifiée)

    -- Table: capteur (3 attributs)
    CREATE TABLE IF NOT EXISTS capteur (
        id_capteur INTEGER PRIMARY KEY AUTOINCREMENT,
        nom_capteur TEXT NOT NULL,
        etat_capteur INTEGER NOT NULL DEFAULT 1 CHECK(etat_capteur IN (0, 1))
    );

    CREATE INDEX IF NOT EXISTS idx_capteur_etat ON capteur(etat_capteur);

    -- Table: evenement (3 attributs)
    CREATE TABLE IF NOT EXISTS evenement (
        id_evenement INTEGER PRIMARY KEY AUTOINCREMENT,
        date TEXT NOT NULL,
        id_capteur INTEGER NOT NULL,
        FOREIGN KEY (id_capteur) REFERENCES capteur(id_capteur) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_evenement_capteur ON evenement(id_capteur);
    CREATE INDEX IF NOT EXISTS idx_evenement_date ON evenement(date DESC);

    -- Table: media (5 attributs)
    CREATE TABLE IF NOT EXISTS media (
        id_media INTEGER PRIMARY KEY AUTOINCREMENT,
        video BLOB NOT NULL,
        date TEXT NOT NULL,
        id_capteur INTEGER NOT NULL,
        numero_camera INTEGER NOT NULL CHECK(numero_camera IN (1, 2)),
        FOREIGN KEY (id_capteur) REFERENCES capteur(id_capteur) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_media_capteur ON media(id_capteur);
    CREATE INDEX IF NOT EXISTS idx_media_date ON media(date DESC);
    CREATE INDEX IF NOT EXISTS idx_media_camera ON media(numero_camera);

    -- Données initiales: Capteurs
    INSERT OR IGNORE INTO capteur (id_capteur, nom_capteur, etat_capteur) VALUES
    (1, 'PIR Entrée', 1),
    (2, 'Tapis Salon', 1),
    (3, 'Bouton Arrêt', 1),
    (4, 'Caméra 1', 1),
    (5, 'Caméra 2', 1);

  init-recordings.sql: |
    -- Initialisation de la base de données recordings.db

    CREATE TABLE IF NOT EXISTS recordings (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        event_id TEXT NOT NULL,
        device_id TEXT NOT NULL,
        timestamp REAL NOT NULL,
        duration INTEGER DEFAULT 10,
        video_blob BLOB,
        video_size INTEGER,
        metadata TEXT,
        created_at DATETIME DEFAULT (datetime('now'))
    );

    -- Index pour améliorer les performances
    CREATE INDEX IF NOT EXISTS idx_recordings_event_id ON recordings(event_id);
    CREATE INDEX IF NOT EXISTS idx_recordings_device_timestamp ON recordings(device_id, timestamp);
    CREATE INDEX IF NOT EXISTS idx_recordings_created_at ON recordings(created_at);
